{% extends "@UVDeskCoreFramework//Templates//layout.html.twig" %}

{% block title %}{{ 'Marketing Announcement'|trans }}{% endblock %}

{% block pageContent %}
	<div class="uv-inner-section">
        {# Append Panel Aside #}
		{% set asideTemplate = 'Webkul\\UVDesk\\CoreFrameworkBundle\\Dashboard\\AsideTemplate' %}
		{% set asideSidebarReference = 'Webkul\\UVDesk\\SupportCenterBundle\\UIComponents\\Dashboard\\Panel\\Sidebars\\Knowledgebase' %}

		{{ uvdesk_extensibles.getRegisteredComponent(asideTemplate).renderSidebar(asideSidebarReference) | raw }}
		
		<div class="uv-view {% if app.request.cookies and app.request.cookies.get('uv-asideView') %}uv-aside-view{% endif %}">
			<h1>
				{% if announcement.id %}
					{{ 'Edit Announcement'|trans }}
				{% else %}
					{{ 'Add Announcement'|trans }}
				{% endif %}
			</h1>
			
			<!--Form-->
			<form method="post" action="" id="announcement-form">
				<!-- Field -->
				<div class="uv-element-block">
					<label class="uv-field-label">{{ 'Title'|trans }}</label>
					<div class="uv-field-block">
						<input type="text" name="announcement_form[title]" class="uv-field" value="{{ announcement.title }}" />
					</div>
					<span class="uv-field-info"></span>
				</div>
				<!-- //Field -->

				<!-- Field -->
				<div class="uv-element-block">
					<label class="uv-field-label">{{ 'Promo Text'|trans }}</label>
					<div class="uv-field-block">
						<textarea name="announcement_form[promotext]" class="uv-field">{{ announcement.promoText }}</textarea>
					</div>
					<span class="uv-field-info"></span>
				</div>
				<!-- //Field -->

				<!-- Field -->
				<div class="uv-element-block">
					<label class="uv-field-label">Promo Tag</label>
					<div class="uv-field-block">
						<select name="announcement_form[promotag]" class="uv-select">
							<option value="new" {% if announcement.promotag == "new" %}selected{% endif %}>New</option>
							<option value="update" {% if announcement.promotag == "update" %}selected{% endif %}>Update</option>
							<option value="offer" {% if announcement.promotag == "offer" %}selected{% endif %}>Offer</option>
						</select>
					</div>
					<span class="uv-field-info">Choose a promo tag</span>
				</div>
				<!-- //Field -->

				<!-- Field -->
				<div class="uv-element-block">
					<label class="uv-field-label">Tag-Color</label>
					<div class="uv-field-block">
						<input type="text" name="announcement_form[tagColor]" class="uv-field" value="{{ announcement.tagColor }}" />
					</div>
					<span class="uv-field-info">Tag background color</span>
				</div>
				<!-- //Field -->

				<!-- Field -->
				<div class="uv-element-block">
					<label class="uv-field-label">Link Text</label>
					<div class="uv-field-block">
						<input type="text" name="announcement_form[linkText]" class="uv-field" value="{{ announcement.linkText }}" />
					</div>
					<span class="uv-field-info"></span>
				</div>
				<!-- //Field -->

				<!-- Field -->
				<div class="uv-element-block">
					<label class="uv-field-label">Link URL</label>
					<div class="uv-field-block">
						<input type="text" name="announcement_form[linkURL]" class="uv-field" value="{{ announcement.linkURL }}" placeholder="https://example.com/" />
					</div>
					<span class="uv-field-info"></span>
				</div>
				<!-- //Field -->

				<!-- Field -->
				<div class="uv-element-block">
					<label class="uv-field-label">Status</label>
					<div class="uv-field-block">
						<select name="announcement_form[status]" class="uv-select">
							<option value="1" {% if announcement.isActive == "1" %}selected{% endif %}>Publish</option>
							<option value="0" {% if announcement.isActive == "0" %}selected{% endif %}>Draft</option>
						</select>
					</div>
					<span class="uv-field-info">Choose a status</span>
				</div>
				<!-- //Field -->

				<!-- Field -->
				<div class="uv-element-block">
					<label class="uv-field-label">Groups</label>
					<div class="uv-field-block">
						<select name="announcement_form[group]" class="uv-select">
							{% for group in user_service.getSupportGroups() %}
								{% if announcement.id is not null %}
									<option value="{{group.id}}" 
									{% if (announcement.group.id == group.id) %}selected{% endif %}
									>{{group.name}}</option>
								{% else %}
									<option value="{{group.id}}"
									>{{group.name}}</option>
								{% endif %}
							{% endfor %}
						</select>
					</div>
					<span class="uv-field-info">Choose a group</span>
				</div>
				<!-- //Field -->

				<!--CTA-->
				<input class="uv-btn" href="#" value="{{ 'Save Advertisement'|trans }}" type="submit">
				<!--//CTA-->
			</form>
			<!--//Form-->
		</div>
	</div>
{% endblock %}

{% block footer %}
	{{ parent() }}
	<script type="text/javascript">
		$(function () {
			var AnnouncementModel = Backbone.Model.extend({
				validation: {
					'announcement_form[title]':[{
						required: true,
						msg: "{{ 'This field is mandatory'|trans }}"
					},{
                        maxLength: 16,
                        msg: '{{ "Maximum character length is 16" | trans}}'
                    }],
					'announcement_form[promotext]': [{
						required: true,
						msg: "{{ 'This field is mandatory'|trans }}"
					},{
                        maxLength: 80,
                        msg: '{{ "Maximum character length is 80" | trans}}'
                    }],
					'announcement_form[promotag]': {
						required: true,
						msg: "{{ 'This field is mandatory'|trans }}"
					},
					'announcement_form[linkText]': [{
						required: true,
						msg: "{{ 'This field is mandatory'|trans }}"
					},{
                        maxLength: 16,
                        msg: '{{ "Maximum character length is 16" | trans}}'
                    }],
					'announcement_form[linkURL]': {
						required: true,
						msg: "{{ 'This field is mandatory'|trans }}"
					},
					'announcement_form[status]': {
						required: true,
						msg: "{{ 'This field is mandatory'|trans }}"
					},
					'announcement_form[group]': {
						required: true,
						msg: "{{ 'This field is mandatory'|trans }}"
					}
				}
			});

			var AnnouncementForm = Backbone.View.extend({
				events : {
					'click .uv-btn': "savePromotion"
				},
				initialize : function() {
					Backbone.Validation.bind(this);
					var jsonContext = '';
		    		for (var field in jsonContext) {
		    			Backbone.Validation.callbacks.invalid(this, field, jsonContext[field], 'input');
					}
				},
				formChanegd: function(e) {
			    	// this.model.set(Backbone.$(e.currentTarget).attr('title'), Backbone.$(e.currentTarget).val())
			    	// this.model.isValid([Backbone.$(e.currentTarget).attr('name')])
			    },
				savePromotion : function (e) {
					debugger
					e.preventDefault();
			        this.model.set(this.$el.serializeObject());
					if(this.model.isValid(true)) {
						this.$el.find('.uv-btn').attr('disabled', 'disabled');
						this.$el.submit();
			        }
				},
                setAddedIds: function(selector) {
                    var ids = [];
                    $(selector).find('.uv-filtered-tags .uv-btn-small').each(function() {
                        ids.push($(this).attr('data-id'))
                    });

                    $(selector).find("input[type='hidden']").val(ids.join(','))

					return ids;
                },
                addEntity: function(e) {
                    currentElement = Backbone.$(e.currentTarget);
                    if(id = currentElement.attr("data-id")) {
                        parent = currentElement.parents(".uv-field-block");
                        parent.find('input').val('')
                        parent.find("li:not(.uv-no-results)").show()
                        if(!parent.find(".uv-filtered-tags a[data-id='" + id + "']").length) {
                            parent.find('.uv-filtered-tags').append("<a class='uv-btn-small default' href='#' data-id='" + id + "'>"+currentElement.text()+"<span class='uv-icon-remove'></span></a>")
                            this.setAddedIds("#" + parent.attr('id'))
                        }
                    }
                },
                removeEntity: function(e) {
                    var parent = Backbone.$(e.currentTarget).parents(".uv-field-block")
                    Backbone.$(e.currentTarget).remove()
                    this.setAddedIds("#" + parent.attr('id'))
                }
			});

			announcementForm = new AnnouncementForm({
				el : $("#announcement-form"),
				model : new AnnouncementModel()
			});	
		});
	</script>
{% endblock %}